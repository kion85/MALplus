#include <iostream>
#include <cstdint>
#include <string>
#include <sstream>
#include <algorithm>

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã MAL+ (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞)
struct MALPlusVM {
    uint8_t  r0 = 0;               // –û—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–±–æ—á–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
    uint8_t  pc = 0;               // –°—á–µ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥ / —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –≤—ã–ø–æ–ª–Ω—è–µ–º—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
    bool     cf = false;           // –§–ª–∞–≥ –ø–µ—Ä–µ–Ω–æ—Å–∞ / —Ñ–ª–∞–≥ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Å–ª–æ–≤–∏–π
    uint8_t  cycle_counter = 0;    // –°—á–µ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Ü–∏–∫–ª–æ–≤ –∏–∑ –≥—Ä—É–ø–ø—ã 6
    uint8_t  ram[256] = {0};       // –û–±—â–∞—è –ø–∞–º—è—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º –∏ –¥–∞–Ω–Ω—ã—Ö 256 –±–∞–π—Ç
    bool     running = true;       // –§–ª–∞–≥ —Ä–∞–±–æ—Ç—ã –º–∞—à–∏–Ω—ã –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º –∑–∞–ø—É—Å–∫–µ

    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –í–ú –¥–æ –∑–∞–≤–æ–¥—Å–∫–∏—Ö —É—Å—Ç–∞–Ω–æ–≤–æ–∫
    void reset() {
        r0 = 0;
        pc = 0;
        cf = false;
        cycle_counter = 0;
        std::fill(std::begin(ram), std::end(ram), 0);
        running = true;
    }

    // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã –∑–∞ –æ–¥–∏–Ω —Ç–∞–∫—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    void step() {
        if (pc >= 256) {
            std::cout << "[–û–®–ò–ë–ö–ê] –ö–æ–Ω–µ—Ü –ø–∞–º—è—Ç–∏, –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞\n";
            running = false;
            return;
        }
        const uint8_t opcode = ram[pc];
        switch (opcode) {
            // ============== –ì–†–£–ü–ü–ê 1: –í–´–í–û–î –¶–ò–§–† ==============
            case 0x11: std::cout << "1"; pc++; break;
            case 0x12: std::cout << "2"; pc++; break;
            case 0x13: std::cout << "3"; pc++; break;

            // ============== –ì–†–£–ü–ü–ê 2: –ë–ò–¢–û–í–´–ï –°–î–í–ò–ì–ò ==============
            case 0x21: r0 = r0 << 1; pc++; break;
            case 0x22: r0 = r0 << 2; pc++; break;
            case 0x23: r0 = r0 * 6; pc++; break;

            // ============== –ì–†–£–ü–ü–ê 3: –°–õ–û–ñ–ï–ù–ò–ï –¢–†–û–ô–ö–ò ==============
            case 0x31: r0 = 3 + 3; pc++; break;
            case 0x32: r0 += 3; pc++; break;
            case 0x33: r0 += 3; pc++; break;

            // ============== –ì–†–£–ü–ü–ê 4: –ü–û–õ–£–ß–ï–ù–ò–ï –ß–ò–°–õ–ê 12 ==============
            case 0x41: r0 = 0; pc++; break;
            case 0x42: r0 += 10; pc++; break;
            case 0x43: r0 += 2; pc++; break;

            // ============== –ì–†–£–ü–ü–ê 5: –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–•–û–î–ê –ß–ï–†–ï–ó –î–ï–°–Ø–¢–û–ö ==============
            case 0x51: cf = (r0 >= 10); pc++; break;
            case 0x52: cf = (r0 >= 15); pc++; break;
            case 0x53: if(cf) std::cout << "\n[–õ–û–ì–ò–ö–ê] –û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–µ—Ä–µ—Ö–æ–¥ —á–µ—Ä–µ–∑ –ø–æ—Ä–æ–≥ –∑–Ω–∞—á–µ–Ω–∏—è\n"; pc++; break;

            // ============== –ì–†–£–ü–ü–ê 6: –¶–ò–ö–õ –ò–ó 6 –ü–û–í–¢–û–†–ï–ù–ò–ô ==============
            case 0x61: cycle_counter = 6; pc++; break;
            case 0x62: r0 += 1; pc++; break;
            case 0x63: 
                cycle_counter--;
                if(cycle_counter > 0) pc = pc - 2; // –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–æ–º–∞–Ω–¥–µ 6x2
                else pc++;
                break;

            // ============== –ì–†–£–ü–ü–ê 7: –ù–ê–ì–†–£–ó–ö–ê –ù–ê –ü–†–û–¶–ï–°–°–û–† ==============
            case 0x71: for(volatile int i = 0; i < 1000; i++); pc++; break;
            case 0x72: for(volatile int i = 0; i < 10000; i++); pc++; break;
            case 0x73: for(volatile int i = 0; i < 100000; i++); pc++; break;

            // ============== –ì–†–£–ü–ü–ê 8: –§–ò–ù–ê–õ –í–´–ü–û–õ–ù–ï–ù–ò–Ø ==============
            case 0x81: r0 = 24; pc++; break;
            case 0x82: std::cout << "\n[–í–´–í–û–î] –ò—Ç–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: " << (int)r0 << "\n"; pc++; break;
            case 0x83: running = false; break;

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –æ–ø–∫–æ–¥–∞
            default:
                std::cout << "\n[–û–®–ò–ë–ö–ê] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –ø–æ –∞–¥—Ä–µ—Å—É 0x" << std::hex << (int)pc << "\n";
                running = false;
                break;
        }
    }

    // –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–æ –∫–æ–º–∞–Ω–¥—ã STOP
    void run() {
        std::cout << "=== –ó–∞–ø—É—Å–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã ===\n";
        while(running) step();
        std::cout << "=== –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ===\n";
    }

    // –í—ã–≤–æ–¥ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
    void print_registers() {
        std::cout << "---- –°–æ—Å—Ç–æ—è–Ω–∏–µ MAL+ –í–ú ----\n";
        std::cout << "R0 = " << (int)r0 << "\n";
        std::cout << "PC = 0x" << std::hex << (int)pc << std::dec << "\n";
        std::cout << "–§–ª–∞–≥ CF = " << (cf ? "–£–°–¢–ê–ù–û–í–õ–ï–ù" : "—Å–±—Ä–æ—à–µ–Ω") << "\n";
        std::cout << "–°—á–µ—Ç—á–∏–∫ —Ü–∏–∫–ª–æ–≤ = " << (int)cycle_counter << "\n";
        std::cout << "---------------------------\n";
    }
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥ –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å
void process_user_command(MALPlusVM &vm, const std::string &input) {
    std::stringstream ss(input);
    std::string cmd;
    ss >> cmd;

    if (cmd == "/+") {
        int val;
        if (ss >> val && val >=0 && val <=255) {
            vm.r0 += val;
            std::cout << "‚úÖ –ü—Ä–∏–±–∞–≤–ª–µ–Ω–æ " << val << ", —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ R0 = " << (int)vm.r0 << "\n";
        } else {
            std::cout << "‚ùå –û—à–∏–±–∫–∞! –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /+ –ß–ò–°–õ–û (–æ—Ç 0 –¥–æ 255)\n";
        }
        return;
    }

    if (cmd == "/-") {
        int val;
        if (ss >> val && val >=0 && val <=255) {
            vm.r0 -= val;
            std::cout << "‚úÖ –û—Ç–Ω—è—Ç–æ " << val << ", —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ R0 = " << (int)vm.r0 << "\n";
        } else {
            std::cout << "‚ùå –û—à–∏–±–∫–∞! –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /- –ß–ò–°–õ–û (–æ—Ç 0 –¥–æ 255)\n";
        }
        return;
    }

    if (cmd == "/regs") {
        vm.print_registers();
        return;
    }

    if (cmd == "/step") {
        vm.step();
        return;
    }

    if (cmd == "/run") {
        vm.run();
        return;
    }

    if (cmd == "/reset") {
        vm.reset();
        std::cout << "‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –í–ú —Å–±—Ä–æ—à–µ–Ω–æ\n";
        return;
    }

    if (cmd == "/set") {
        std::string reg;
        int val;
        if (ss >> reg >> val && reg == "R0" && val >=0 && val <=255) {
            vm.r0 = val;
            std::cout << "‚úÖ –í R0 –∑–∞–ø–∏—Å–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ " << val << "\n";
        } else {
            std::cout << "‚ùå –û—à–∏–±–∫–∞! –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /set R0 –ß–ò–°–õ–û (–æ—Ç 0 –¥–æ 255)\n";
        }
        return;
    }

    if (cmd == "/exit") {
        std::cout << "üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!\n";
        exit(0);
    }

    std::cout << "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: /+, /-, /regs, /step, /run, /set, /reset, /exit\n";
}

int main() {
    MALPlusVM vm;
    // –ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π –≤ –ø–∞–º—è—Ç—å, –≤—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –µ—ë
    int addr = 0;
    vm.ram[addr++] = 0x11; // 1x1 –Ω–∞–ø–µ—á–∞—Ç–∞—Ç—å 1
    vm.ram[addr++] = 0x12; // 1x2 –Ω–∞–ø–µ—á–∞—Ç–∞—Ç—å 2
    vm.ram[addr++] = 0x13; // 1x3 –Ω–∞–ø–µ—á–∞—Ç–∞—Ç—å 3
    vm.ram[addr++] = 0x81;
    vm.ram[addr++] = 0x82;
    vm.ram[addr++] = 0x83;

    std::cout << "=====================================\n";
    std::cout << "  MAL+ –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ú–∞—à–∏–Ω–∞ v2.0\n";
    std::cout << "  –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –≤–≤–æ–¥—è—Ç—Å—è —á–µ—Ä–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å /\n";
    std::cout << "=====================================\n";

    // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    std::string input;
    while(true) {
        std::cout << "\n> ";
        std::getline(std::cin, input);
        if (input.empty()) continue;
        if (input[0] != '/') {
            std::cout << "‚ÑπÔ∏è –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã –¥–æ–ª–∂–Ω—ã –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å —Å–∏–º–≤–æ–ª–∞ /\n";
            continue;
        }
        process_user_command(vm, input);
    }

    return 0;
}
